#!/usr/bin/env bash

set -eo pipefail

source "$(dirname "$0")/../lib/debug.sh"

download() {

  local install_type="$1"
  local version="$2"
  local install_path="$3"

  debug "installation type: $install_type"
  debug "installation version: $version" 
  debug "installation path: $install_path"
  debug "content of installation path:"
  
  if is_debug; then 
    ls -l $install_path
  fi

  debug "download path: $ASDF_DOWNLOAD_PATH"
  debug "content of download path:"

  if is_debug; then
    ls -l $ASDF_DOWNLOAD_PATH/bin
  fi

  if [ "$install_type" != "version" ]; then
    fail "asdf-dvc supports release installs only"
  fi

  echo "Installing DVC $version..."
  
  if [[ -z ${ASDF_DOWNLOAD_PATH} ]]; then
    pip3 install -q --progress-bar off -t $install_path "dvc[all]==$version" > /dev/null 2>&1 || fail "dvc: fail to download dvc $version"
  else
    mkdir -p $ASDF_INSTALL_PATH/bin 
    ln -sf $ASDF_DOWNLOAD_PATH/bin/dvc $ASDF_INSTALL_PATH/bin/dvc
  fi

  echo "Installation completed"

  if is_debug; then 
    ls -l $ASDF_INSTALL_PATH/bin
  fi
}


download "$ASDF_INSTALL_TYPE" "$ASDF_INSTALL_VERSION" "$ASDF_INSTALL_PATH"
